<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X Auto Scraper</title>
    <!-- Tailwind CSS (CDN for simplicity) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .custom-loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen text-gray-800 font-sans">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm">
        <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <h1 class="text-xl font-bold tracking-tight">AutoScraper <span class="text-blue-500"></span></h1>
            </div>
            <div class="flex items-center space-x-4">
                <button onclick="checkHealth()" id="btn-health"
                    class="text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-lg flex items-center gap-1 transition">
                    <i class="fa-solid fa-stethoscope text-green-600"></i>
                    <span>Health Check</span>
                </button>
                <span id="system-status" class="flex items-center space-x-2 text-sm text-gray-500">
                    <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                    <span>System Ready</span>
                </span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-4xl mx-auto px-4 py-8">

        <!-- Input Section -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-8">
            <h2 class="text-lg font-semibold mb-4 border-b pb-2">üöÄ Start New Job</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Search Keyword</label>
                    <input type="text" id="keyword"
                        class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                        placeholder="e.g. banjir aceh, korban banjir, pemerintah lambat (Batch Input)">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Count</label>
                    <input type="number" id="count"
                        class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none" value="100">
                </div>
                <div>
                    <!-- Worker & Merge Settings -->
                    <label class="block text-sm font-medium text-gray-700 mb-1">Worker Mode ‚ö°</label>
                    <select id="worker_mode"
                        class="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none mb-2">
                        <option value="1">Safe (1 Worker) üõ°Ô∏è</option>
                        <option value="3" selected>Normal (3) üöÄ</option>
                        <option value="5">Aggressive (5) üî•</option>
                    </select>
                </div>
            </div>

            <!-- Row 2: Button Only -->
            <div class="mb-4">
                <button onclick="startJob()" id="btn-start"
                    class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700 transition flex justify-center items-center gap-2">
                    <i class="fa-solid fa-play"></i> Start Scraping
                </button>
            </div>

            <!-- Advanced Options (Date) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2 p-3 bg-gray-50 rounded">
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Start Date (Optional)</label>
                    <input type="date" id="start_date" class="w-full p-1 border rounded text-sm">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">End Date (Optional)</label>
                    <input type="date" id="end_date" class="w-full p-1 border rounded text-sm">
                </div>
            </div>

            <!-- Smart Mode Toggle -->
            <div class="mt-3 p-3 bg-blue-50 rounded border border-blue-100 flex items-center gap-3">
                <input type="checkbox" id="smartMode"
                    class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 cursor-pointer">
                <div>
                    <label for="smartMode" class="font-medium text-blue-900 cursor-pointer block text-sm">Enable Smart
                        Search (AI Expansion) üß†</label>
                    <p class="text-xs text-blue-700">Auto-discovers hashtags & expands query (e.g. adds #banjiraceh)</p>
                </div>
            </div>
        </div>

        <!-- Job Monitor Section -->
        <h2 class="text-lg font-semibold mb-4 flex items-center space-x-2">
            <i class="fa-solid fa-list-check text-blue-500"></i>
            <span>Active Jobs</span>
            <button onclick="fetchJobs()" class="text-xs text-gray-500 hover:text-blue-500 ml-2">
                <i class="fa-solid fa-arrows-rotate"></i>
            </button>
        </h2>

        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <table class="w-full text-left">
                <thead class="bg-gray-50 border-b">
                    <tr>
                        <th class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase">Keyword</th>
                        <th class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase">Status</th>
                        <th class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase">Progress</th>
                        <th class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase">Action</th>
                    </tr>
                </thead>
                <tbody id="job-list" class="divide-y divide-gray-100">
                    <!-- Jobs will be injected here -->
                    <tr>
                        <td colspan="4" class="px-6 py-8 text-center text-gray-400">
                            No jobs found. Start your first scrape!
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Rate Limit Meter -->
        <div class="mt-6 bg-white rounded-xl shadow-md p-4">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-700">üå°Ô∏è Rate Limit Meter</span>
                <span id="rate-status"
                    class="text-xs font-medium px-2 py-1 rounded bg-green-100 text-green-700">COOL</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3">
                <div id="rate-bar" class="bg-green-500 h-3 rounded-full transition-all duration-300" style="width: 0%">
                </div>
            </div>
            <div class="flex justify-between text-xs text-gray-500 mt-1">
                <span id="rate-current">0 req/min</span>
                <span id="rate-max">Max: 30 req/min</span>
            </div>
        </div>

        <!-- Live Log Viewer -->
        <div class="mt-6">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-semibold text-gray-700 flex items-center gap-2">
                    <i class="fa-solid fa-terminal text-gray-500"></i>
                    Live Logs
                </h3>
                <button onclick="clearLogs()" class="text-xs text-gray-500 hover:text-red-500">
                    <i class="fa-solid fa-trash"></i> Clear
                </button>
            </div>
            <div id="log-viewer"
                class="bg-gray-900 text-green-400 font-mono text-xs p-3 rounded-lg h-40 overflow-y-auto">
                <div class="text-gray-500">Waiting for logs...</div>
            </div>
        </div>

    </div>

    <!-- JS Logic -->
    <script>
        async function startJob() {
            const keyword = document.getElementById('keyword').value;
            const count = document.getElementById('count').value;
            const start_date = document.getElementById('start_date').value;
            const end_date = document.getElementById('end_date').value;
            const smartMode = document.getElementById('smartMode') ? document.getElementById('smartMode').checked : false;

            // Fix: Retrieve these values from DOM
            const workerMode = document.getElementById('worker_mode').value;

            if (!keyword) {
                alert('Please enter a keyword');
                return;
            }

            const btn = document.querySelector('button[onclick="startJob()"]');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Starting...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/jobs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keyword: keyword,
                        count: parseInt(count),
                        start_date: start_date,
                        end_date: end_date,
                        smart_mode: smartMode,
                        worker_mode: parseInt(workerMode)
                    })
                });

                if (response.ok) {
                    await fetchJobs(); // Refresh list immediately
                    document.getElementById('keyword').value = ''; // Clear input
                } else {
                    alert('Failed to start job');
                }
            } catch (error) {
                console.error(error);
                alert('Connection error');
            } finally {
                // Reset UI
                btn.innerHTML = `<i class="fa-solid fa-play"></i><span>Start Scraping</span>`;
                btn.disabled = false;
            }
        }

        async function fetchJobs() {
            try {
                const response = await fetch('/api/jobs');
                const jobs = await response.json();
                renderJobs(jobs);
            } catch (error) {
                console.error("Error fetching jobs:", error);
            }
        }

        function renderJobs(jobs) {
            const tbody = document.getElementById('job-list');
            if (jobs.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="px-6 py-8 text-center text-gray-400">No jobs found.</td></tr>`;
                return;
            }

            let html = '';
            for (const job of jobs) {
                let statusColor = 'bg-gray-100 text-gray-600';
                let icon = '<i class="fa-regular fa-clock"></i>';

                if (job.status === 'RUNNING') {
                    statusColor = 'bg-blue-100 text-blue-600 animate-pulse';
                    icon = '<i class="fa-solid fa-spinner fa-spin"></i>';
                } else if (job.status === 'COMPLETED') {
                    statusColor = 'bg-green-100 text-green-600';
                    icon = '<i class="fa-solid fa-check"></i>';
                } else if (job.status === 'FAILED') {
                    statusColor = 'bg-red-100 text-red-600';
                    icon = '<i class="fa-solid fa-triangle-exclamation"></i>';
                }

                const createdTime = new Date(job.created_at).toLocaleTimeString();
                const filename = job.result_file ? job.result_file.split('/').pop() : '#';

                html += `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4">
                            <div class="font-medium text-gray-900">${job.keyword}</div>
                            <div class="text-xs text-gray-500">${createdTime} ‚Ä¢ Target: ${job.target_count}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor} space-x-1">
                                ${icon}
                                <span>${job.status}</span>
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            ${(() => {
                        // Extract progress numbers if available
                        const progressMatch = (job.progress || '').match(/(\d+)\/(\d+)/);
                        if (progressMatch && job.status === 'RUNNING') {
                            const current = parseInt(progressMatch[1]);
                            const total = parseInt(progressMatch[2]);
                            const percent = Math.min(100, Math.round((current / total) * 100));
                            return `
                                        <div class="w-full">
                                            <div class="flex justify-between text-xs text-gray-600 mb-1">
                                                <span>${current}/${total}</span>
                                                <span>${percent}%</span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-2">
                                                <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: ${percent}%"></div>
                                            </div>
                                        </div>
                                    `;
                        }
                        return `<span class="text-sm text-gray-600">${job.progress || '-'}</span>`;
                    })()}
                        </td>
                        <td class="px-6 py-4 text-right">
                            ${job.status === 'COMPLETED' ?
                        `<a href="/download/${filename}" class="text-blue-600 hover:text-blue-800 font-medium text-sm flex items-center space-x-1">
                                    <i class="fa-solid fa-download"></i>
                                    <span>Download</span>
                                </a>` :
                        '<span class="text-gray-300">-</span>'
                    }
                        </td>
                    </tr>
                `;
            }
            tbody.innerHTML = html;
        }

        // Health Check Function
        async function checkHealth() {
            const btn = document.getElementById('btn-health');
            const status = document.getElementById('system-status');

            // Update UI to loading
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Checking...';
            btn.disabled = true;
            status.innerHTML = '<span class="w-3 h-3 bg-yellow-500 rounded-full animate-pulse"></span><span>Checking...</span>';

            try {
                const response = await fetch('/api/health-check');
                const result = await response.json();

                let color = 'green';
                let icon = 'fa-check-circle';
                let text = 'Healthy';

                if (result.status === 'WARNING') {
                    color = 'yellow';
                    icon = 'fa-exclamation-triangle';
                    text = 'Warning';
                } else if (result.status === 'ERROR') {
                    color = 'red';
                    icon = 'fa-times-circle';
                    text = 'Error';
                }

                status.innerHTML = `
                    <span class="w-3 h-3 bg-${color}-500 rounded-full"></span>
                    <span class="text-${color}-600 font-medium">${text}</span>
                `;

                // Show detailed result
                let message = `ü©∫ Account Health: ${result.status}\n\n`;
                message += `‚úì Can Search: ${result.can_search ? 'Yes' : 'No'}\n`;
                message += `‚úì Can See Tweets: ${result.can_see_tweets ? 'Yes' : 'No'}\n\n`;
                if (result.warnings.length > 0) {
                    message += `‚ö†Ô∏è Warnings:\n${result.warnings.join('\n')}\n\n`;
                }
                message += `üí° ${result.recommendation}`;

                alert(message);

            } catch (error) {
                status.innerHTML = '<span class="w-3 h-3 bg-red-500 rounded-full"></span><span class="text-red-600">Error</span>';
                alert('Health check failed: ' + error.message);
            } finally {
                btn.innerHTML = '<i class="fa-solid fa-stethoscope text-green-600"></i> <span>Health Check</span>';
                btn.disabled = false;
            }
        }

        // ==================
        // LIVE LOG VIEWER
        // ==================
        async function fetchLogs() {
            try {
                const response = await fetch('/api/logs');
                const logs = await response.json();
                const viewer = document.getElementById('log-viewer');

                if (logs.length === 0) {
                    viewer.innerHTML = '<div class="text-gray-500">Waiting for logs...</div>';
                    return;
                }

                let html = '';
                for (const log of logs) {
                    const levelColor = log.level === 'ERROR' ? 'text-red-400' :
                        log.level === 'WARNING' ? 'text-yellow-400' : 'text-green-400';
                    html += `<div><span class="text-gray-500">[${log.time}]</span> <span class="${levelColor}">${log.message}</span></div>`;
                }
                viewer.innerHTML = html;
                viewer.scrollTop = viewer.scrollHeight; // Auto-scroll to bottom
            } catch (error) {
                console.error('Log fetch error:', error);
            }
        }

        function clearLogs() {
            document.getElementById('log-viewer').innerHTML = '<div class="text-gray-500">Logs cleared.</div>';
        }

        // ==================
        // RATE LIMIT METER
        // ==================
        async function fetchRateStatus() {
            try {
                const response = await fetch('/api/rate-status');
                const data = await response.json();

                // Update UI
                document.getElementById('rate-status').textContent = data.status;
                document.getElementById('rate-status').className = `text-xs font-medium px-2 py-1 rounded bg-${data.color}-100 text-${data.color}-700`;
                document.getElementById('rate-bar').style.width = data.percent + '%';
                document.getElementById('rate-bar').className = `bg-${data.color}-500 h-3 rounded-full transition-all duration-300`;
                document.getElementById('rate-current').textContent = data.current_rpm + ' req/min';
                document.getElementById('rate-max').textContent = 'Max: ' + data.max_rpm + ' req/min';
            } catch (error) {
                console.error('Rate status fetch error:', error);
            }
        }

        // ==================
        // DATA PREVIEW
        // ==================
        async function previewData(jobId) {
            try {
                const response = await fetch(`/api/preview/${jobId}`);
                const data = await response.json();

                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }

                // Simple table display
                let previewHtml = '<table style="width:100%; border-collapse: collapse; font-size: 12px;">';
                if (data.preview.length > 0) {
                    // Headers
                    previewHtml += '<tr>';
                    for (const key of Object.keys(data.preview[0]).slice(0, 5)) {
                        previewHtml += `<th style="border: 1px solid #ddd; padding: 4px; background: #f5f5f5;">${key}</th>`;
                    }
                    previewHtml += '</tr>';

                    // Rows
                    for (const row of data.preview) {
                        previewHtml += '<tr>';
                        for (const key of Object.keys(row).slice(0, 5)) {
                            let val = String(row[key] || '').substring(0, 50);
                            previewHtml += `<td style="border: 1px solid #ddd; padding: 4px;">${val}</td>`;
                        }
                        previewHtml += '</tr>';
                    }
                }
                previewHtml += '</table>';

                // Show in alert (simple approach)
                const div = document.createElement('div');
                div.innerHTML = previewHtml;
                alert('Preview (first 10 rows, 5 columns):\n\n' + div.textContent);

            } catch (error) {
                alert('Preview failed: ' + error.message);
            }
        }

        // Auto refresh every 3 seconds
        setInterval(fetchJobs, 3000);
        setInterval(fetchLogs, 2000);  // Logs refresh more frequently
        setInterval(fetchRateStatus, 5000);  // Rate every 5 seconds
        fetchJobs(); // Initial fetch
        fetchRateStatus(); // Initial rate fetch
    </script>
</body>

</html>