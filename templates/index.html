<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X Auto Scraper</title>
    <!-- Tailwind CSS (CDN for simplicity) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .custom-loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen text-gray-800 font-sans">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm">
        <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <h1 class="text-xl font-bold tracking-tight">AutoScraper <span class="text-blue-500"></span></h1>
            </div>
            <div class="text-sm text-gray-500">
                <span id="system-status" class="flex items-center space-x-2">
                    <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                    <span>System Ready</span>
                </span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-4xl mx-auto px-4 py-8">

        <!-- Input Section -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-8">
            <h2 class="text-lg font-semibold mb-4 border-b pb-2">üöÄ Start New Job</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Search Keyword</label>
                    <input type="text" id="keyword"
                        class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                        placeholder="e.g. banjir aceh, korban banjir, pemerintah lambat (Batch Input)">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Count</label>
                    <input type="number" id="count"
                        class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none" value="100">
                </div>
                <div>
                    <!-- Worker & Merge Settings -->
                    <label class="block text-sm font-medium text-gray-700 mb-1">Worker Mode ‚ö°</label>
                    <select id="worker_mode"
                        class="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none mb-2">
                        <option value="1">Safe (1 Worker) üõ°Ô∏è</option>
                        <option value="3" selected>Normal (3) üöÄ</option>
                        <option value="5">Aggressive (5) üî•</option>
                    </select>
                </div>
            </div>

            <!-- Row 2: Button Only -->
            <div class="mb-4">
                <button onclick="startJob()" id="btn-start"
                    class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700 transition flex justify-center items-center gap-2">
                    <i class="fa-solid fa-play"></i> Start Scraping
                </button>
            </div>

            <!-- Advanced Options (Date) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2 p-3 bg-gray-50 rounded">
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Start Date (Optional)</label>
                    <input type="date" id="start_date" class="w-full p-1 border rounded text-sm">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">End Date (Optional)</label>
                    <input type="date" id="end_date" class="w-full p-1 border rounded text-sm">
                </div>
            </div>

            <!-- Smart Mode Toggle -->
            <div class="mt-3 p-3 bg-blue-50 rounded border border-blue-100 flex items-center gap-3">
                <input type="checkbox" id="smartMode"
                    class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 cursor-pointer">
                <div>
                    <label for="smartMode" class="font-medium text-blue-900 cursor-pointer block text-sm">Enable Smart
                        Search (AI Expansion) üß†</label>
                    <p class="text-xs text-blue-700">Auto-discovers hashtags & expands query (e.g. adds #banjiraceh)</p>
                </div>
            </div>
        </div>

        <!-- Job Monitor Section -->
        <h2 class="text-lg font-semibold mb-4 flex items-center space-x-2">
            <i class="fa-solid fa-list-check text-blue-500"></i>
            <span>Active Jobs</span>
            <button onclick="fetchJobs()" class="text-xs text-gray-500 hover:text-blue-500 ml-2">
                <i class="fa-solid fa-arrows-rotate"></i>
            </button>
        </h2>

        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <table class="w-full text-left">
                <thead class="bg-gray-50 border-b">
                    <tr>
                        <th class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase">Keyword</th>
                        <th class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase">Status</th>
                        <th class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase">Progress</th>
                        <th class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase">Action</th>
                    </tr>
                </thead>
                <tbody id="job-list" class="divide-y divide-gray-100">
                    <!-- Jobs will be injected here -->
                    <tr>
                        <td colspan="4" class="px-6 py-8 text-center text-gray-400">
                            No jobs found. Start your first scrape!
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>

    <!-- JS Logic -->
    <script>
        async function startJob() {
            const keyword = document.getElementById('keyword').value;
            const count = document.getElementById('count').value;
            const start_date = document.getElementById('start_date').value;
            const end_date = document.getElementById('end_date').value;
            const smartMode = document.getElementById('smartMode') ? document.getElementById('smartMode').checked : false;

            // Fix: Retrieve these values from DOM
            const workerMode = document.getElementById('worker_mode').value;

            if (!keyword) {
                alert('Please enter a keyword');
                return;
            }

            const btn = document.querySelector('button[onclick="startJob()"]');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Starting...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/jobs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keyword: keyword,
                        count: parseInt(count),
                        start_date: start_date,
                        end_date: end_date,
                        smart_mode: smartMode,
                        worker_mode: parseInt(workerMode)
                    })
                });

                if (response.ok) {
                    await fetchJobs(); // Refresh list immediately
                    document.getElementById('keyword').value = ''; // Clear input
                } else {
                    alert('Failed to start job');
                }
            } catch (error) {
                console.error(error);
                alert('Connection error');
            } finally {
                // Reset UI
                btn.innerHTML = `<i class="fa-solid fa-play"></i><span>Start Scraping</span>`;
                btn.disabled = false;
            }
        }

        async function fetchJobs() {
            try {
                const response = await fetch('/api/jobs');
                const jobs = await response.json();
                renderJobs(jobs);
            } catch (error) {
                console.error("Error fetching jobs:", error);
            }
        }

        function renderJobs(jobs) {
            const tbody = document.getElementById('job-list');
            if (jobs.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="px-6 py-8 text-center text-gray-400">No jobs found.</td></tr>`;
                return;
            }

            let html = '';
            for (const job of jobs) {
                let statusColor = 'bg-gray-100 text-gray-600';
                let icon = '<i class="fa-regular fa-clock"></i>';

                if (job.status === 'RUNNING') {
                    statusColor = 'bg-blue-100 text-blue-600 animate-pulse';
                    icon = '<i class="fa-solid fa-spinner fa-spin"></i>';
                } else if (job.status === 'COMPLETED') {
                    statusColor = 'bg-green-100 text-green-600';
                    icon = '<i class="fa-solid fa-check"></i>';
                } else if (job.status === 'FAILED') {
                    statusColor = 'bg-red-100 text-red-600';
                    icon = '<i class="fa-solid fa-triangle-exclamation"></i>';
                }

                const createdTime = new Date(job.created_at).toLocaleTimeString();
                const filename = job.result_file ? job.result_file.split('/').pop() : '#';

                html += `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4">
                            <div class="font-medium text-gray-900">${job.keyword}</div>
                            <div class="text-xs text-gray-500">${createdTime} ‚Ä¢ Target: ${job.target_count}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor} space-x-1">
                                ${icon}
                                <span>${job.status}</span>
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-600">
                            ${job.progress || '-'}
                        </td>
                        <td class="px-6 py-4 text-right">
                            ${job.status === 'COMPLETED' ?
                        `<a href="/download/${filename}" class="text-blue-600 hover:text-blue-800 font-medium text-sm flex items-center space-x-1">
                                    <i class="fa-solid fa-download"></i>
                                    <span>Download</span>
                                </a>` :
                        '<span class="text-gray-300">-</span>'
                    }
                        </td>
                    </tr>
                `;
            }
            tbody.innerHTML = html;
        }

        // Auto refresh every 3 seconds
        setInterval(fetchJobs, 3000);
        fetchJobs(); // Initial fetch
    </script>
</body>

</html>